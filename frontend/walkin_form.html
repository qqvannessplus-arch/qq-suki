<!-- templates/walkin_form.html -->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß - Buffet Queue</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- ‚úÖ 1. Import LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        body { background-color: #f8f9fa; }
        .pax-btn {
            height: 70px;
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid #dee2e6;
            background-color: white;
            color: #495057;
            transition: all 0.2s;
        }
        .pax-btn:hover, .pax-btn.active {
            border-color: #0d6efd;
            background-color: #e7f1ff;
            color: #0d6efd;
            transform: scale(1.05);
        }
        /* Loading Overlay Style */
        #loadingOverlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.9);
            z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <!-- üåÄ Loading Overlay (‡∏ï‡∏±‡∏ß‡∏´‡∏°‡∏∏‡∏ô‡πÜ) -->
    <div id="loadingOverlay">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3 text-muted fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...</p>
    </div>

    <div class="container mt-5">
        <div class="card shadow border-0 rounded-4">
            <div class="card-body p-4 text-center">
                <h1 class="fw-bold text-primary mb-2">üç≤ Buffet Queue</h1>
                <p class="text-muted mb-4">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡πà‡∏≤‡∏ô</p>

                <form action="/walkin/submit" method="POST">
                    
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ó‡πà‡∏≤‡∏ô)</label>
                        <div class="row row-cols-3 g-2">
                            <div class="col"><button type="button" class="btn w-100 pax-btn" onclick="selectPax(1)">1</button></div>
                            <div class="col"><button type="button" class="btn w-100 pax-btn" onclick="selectPax(2)">2</button></div>
                            <div class="col"><button type="button" class="btn w-100 pax-btn" onclick="selectPax(3)">3</button></div>
                            <div class="col"><button type="button" class="btn w-100 pax-btn" onclick="selectPax(4)">4</button></div>
                            <div class="col"><button type="button" class="btn w-100 pax-btn" onclick="selectPax(5)">5</button></div>
                            <div class="col"><button type="button" class="btn w-100 pax-btn" onclick="selectPax(6)">6+</button></div>
                        </div>

                        <!-- Input ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô -->
                        <input type="number" name="pax" id="paxInput" class="form-control mt-3 text-center fs-4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" required min="1" style="display:none;">
                    </div>

                    <!-- ‚úÖ Hidden Input ‡πÄ‡∏Å‡πá‡∏ö LINE ID -->
                    <input type="hidden" name="line_user_id" id="lineUserIdField">

                    <!-- ‚úÖ Alert ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
                    <div id="lineStatus" class="alert alert-secondary py-1" style="font-size: 0.8rem; display:none;">
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...
                    </div>

                    <button type="submit" class="btn btn-primary w-100 py-3 fs-4 rounded-pill shadow-sm">
                        ‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏¥‡∏ß üé´
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Script ‡∏£‡∏ß‡∏° Logic ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
    <script>
        // --- 1. Logic ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô ---
        function selectPax(num) {
            const input = document.getElementById('paxInput');
            input.value = num;
            if (num >= 6) {
                input.style.display = 'block';
                input.focus();
            } else {
                input.style.display = 'none';
            }
            document.querySelectorAll('.pax-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // --- 2. Logic ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (Reset -> LocalStorage -> LIFF) ---
        
        async function initSystem() {
            // A. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Reset ‡∏à‡∏≤‡∏Å Server (‡πÅ‡∏Å‡πâ Loop ‡∏ô‡∏£‡∏Å)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('reset')) {
                console.log("‚ôªÔ∏è Server ‡∏™‡∏±‡πà‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á!");
                localStorage.removeItem('my_suki_queue_id');
                // ‡∏•‡πâ‡∏≤‡∏á URL ‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î
                window.history.replaceState({}, document.title, "/walkin");
            }

            // B. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡πâ‡∏≤‡∏á ‡∏î‡∏µ‡∏î‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏π‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
            const savedQueueId = localStorage.getItem('my_suki_queue_id');
            if (savedQueueId) {
                console.log("üöÄ ‡πÄ‡∏à‡∏≠‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á! ‡∏û‡∏≤‡πÑ‡∏õ‡∏î‡∏π‡∏Ñ‡∏¥‡∏ß...");
                window.location.href = "/queue/" + savedQueueId;
                return; // ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
            }

            // C. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡πâ‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏° LIFF
            await initLIFF();
            document.getElementById('loadingOverlay').style.display = 'none';
            console.log("üîß Local Mode: ‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö LINE ‡πÅ‡∏•‡πâ‡∏ß");
        }

        // --- 3. Logic LIFF ---
        async function initLIFF() {
            try {
                // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
                await liff.init({ liffId: "2008763658-K62w632B" });

                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    
                    // ‡πÉ‡∏™‡πà ID ‡∏•‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                    document.getElementById('lineUserIdField').value = profile.userId;

                    // ‡πÇ‡∏ä‡∏ß‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    const statusDiv = document.getElementById('lineStatus');
                    statusDiv.style.display = 'block';
                    statusDiv.className = 'alert alert-success py-1';
                    statusDiv.innerHTML = `‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì: <b>${profile.displayName}</b> ‡πÅ‡∏•‡πâ‡∏ß`;

                    // ‡πÄ‡∏ä‡πá‡∏Ñ ID ‡∏Å‡∏±‡∏ö Server (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)
                    await checkLineAccount(profile.userId);
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
                    liff.login({ redirectUri: window.location.href });
                }
            } catch (err) {
                console.error("LIFF Error:", err);
                // ‡∏ñ‡πâ‡∏≤ Error (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏•‡∏∏‡∏î / ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå) ‡∏Å‡πá‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥
            } finally {
                // ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏´‡∏°‡∏∏‡∏ô‡πÜ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ)
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // --- 4. Logic ‡πÄ‡∏ä‡πá‡∏Ñ Server (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á) ---
        async function checkLineAccount(userId) {
            try {
                const response = await fetch('/api/check-my-queue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ line_user_id: userId })
                });
                const result = await response.json();
                
                if (result.status === 'found') {
                    // ‡πÄ‡∏à‡∏≠‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö! ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏≤‡πÑ‡∏õ
                    localStorage.setItem('my_suki_queue_id', result.queue_id);
                    window.location.href = '/queue/' + result.queue_id;
                }
            } catch (err) {
                console.error(err);
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        initSystem();

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .booking-card {
            max-width: 600px; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
            margin: 2rem auto;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .header-img {
            background: linear-gradient(45deg, #ffc107, #ff9800);
            padding: 30px;
            text-align: center;
            color: #fff;
        }
        .status-badge {
            font-size: 0.9rem;
            cursor: default;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card booking-card bg-white">
        <div class="header-img">
            <h1>üìÖ ‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞</h1>
            <p class="mb-0">‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡∏ï‡πå‡∏™‡∏∏‡∏Å‡∏µ‡πâ‡πÄ‡∏à‡πâ‡∏≤‡πÄ‡∏î‡πá‡∏î (‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≤‡∏ô 90 ‡∏ô‡∏≤‡∏ó‡∏µ)</p>
        </div>
        <div class="card-body p-4">
            
            <!-- ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Error ‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (Flash Message) -->
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="alert alert-danger shadow-sm">{{ message }}</div>
                {% endfor %}
              {% endif %}
            {% endwith %}

            <form action="/booking" method="POST">
                
                <!-- 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                        <input type="text" name="customer_name" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                        <input type="tel" name="phone" class="form-control" placeholder="08x-xxx-xxxx" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô</label>
                        <input type="number" name="pax" class="form-control" value="2" min="1" max="20" required>
                        <small class="text-muted">*‡∏´‡∏≤‡∏Å‡∏°‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 20 ‡∏ó‡πà‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</small>
                    </div>
                </div>

                <hr class="my-4">

                <!-- 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ -->
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</label>
                        <!-- id="dateInput" ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö JS -->
                        <input type="date" name="booking_date" class="form-control" required id="dateInput">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">‡πÄ‡∏ß‡∏•‡∏≤</label>
                        <input type="time" name="booking_time" class="form-control" required>
                        <small class="text-muted" style="font-size: 0.75rem;">*‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 10-15 ‡∏ô‡∏≤‡∏ó‡∏µ</small>
                    </div>
                </div>

                <!-- 3. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) -->
                <div class="mt-4">
                    <h6 class="fw-bold text-secondary">üìä ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏ô‡∏à‡∏≠‡∏á (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h6>
                    <div id="bookingStatusArea" class="p-3 bg-light rounded border text-center">
                        <small class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</small>
                    </div>
                    <small class="text-muted d-block mt-1 text-end">*‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Real-time ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</small>
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-warning btn-lg fw-bold text-dark shadow-sm">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á ‚úÖ
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
    // ----------------------------------------------------
    // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Timezone: Asia/Bangkok)
    // ----------------------------------------------------
    function getThaiDate() {
        const thaiTime = new Date().toLocaleString("en-US", {timeZone: "Asia/Bangkok"});
        const dateObj = new Date(thaiTime);
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å
    const todayStr = getThaiDate();
    const dateInput = document.getElementById('dateInput');
    const statusArea = document.getElementById('bookingStatusArea');

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á Input Date
    dateInput.value = todayStr;
    dateInput.min = todayStr;

    // ----------------------------------------------------
    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Booking ‡∏à‡∏≤‡∏Å API
    // ----------------------------------------------------
    async function fetchBookings() {
        const selectedDate = dateInput.value;
        statusArea.innerHTML = '<div class="spinner-border spinner-border-sm text-secondary" role="status"></div> <small class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏¥‡∏ß...</small>';

        try {
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô app.py
            const response = await fetch(`/api/check-bookings?date=${selectedDate}`);
            
            if (!response.ok) throw new Error("Network response was not ok");
            
            const data = await response.json(); 
            // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á data ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: {'12:00': 2, '13:00': 5}

            // A. ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏à‡∏≠‡∏á‡πÄ‡∏•‡∏¢
            if (Object.keys(data).length === 0) {
                statusArea.innerHTML = `
                    <div class="text-success py-2">
                        <span class="fs-4">‚úÖ</span><br>
                        <strong>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</strong><br>
                        <small>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</small>
                    </div>`;
                return;
            }

            // B. ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏à‡∏≠‡∏á -> ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á Badge
            let html = '<div class="d-flex flex-wrap gap-2 justify-content-center">';
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å
            const sortedTimes = Object.keys(data).sort();
            
            sortedTimes.forEach(time => {
                const count = data[time];
                // Logic ‡∏™‡∏µ: ‡∏à‡∏≠‡∏á‡πÄ‡∏¢‡∏≠‡∏∞ = ‡∏™‡∏µ‡πÅ‡∏î‡∏á, ‡∏à‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢ = ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
                const badgeClass = count >= 3 ? 'bg-danger text-white' : 'bg-warning text-dark';
                
                html += `
                    <span class="badge ${badgeClass} status-badge p-2 shadow-sm">
                        üïí ${time} ‡∏ô. <br>
                        (‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ${count} ‡∏ó‡∏µ‡πà)
                    </span>
                `;
            });
            
            html += '</div>';
            statusArea.innerHTML = html;

        } catch (error) {
            console.error("Fetch Error:", error);
            statusArea.innerHTML = '<small class="text-danger">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ</small>';
        }
    }

    // ----------------------------------------------------
    // 3. Event Listeners
    // ----------------------------------------------------
    
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -> ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
    dateInput.addEventListener('change', fetchBookings);

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à -> ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    window.addEventListener('DOMContentLoaded', fetchBookings);

</script>

</body>
</html>